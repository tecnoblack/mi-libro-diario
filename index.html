<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Contable - Libro Diario Inteligente</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-color: #c9d1d9;
            --border-color: #30363d;
            --accent-color: #238636;
            --error-color: #f85149;
            --success-color: #3fb950;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 20px;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background-color: #21262d;
            text-align: left;
            padding: 12px;
            border: 1px solid var(--border-color);
        }

        td {
            padding: 8px;
            border: 1px solid var(--border-color);
        }

        input {
            background-color: #0d1117;
            color: white;
            border: 1px solid var(--border-color);
            padding: 8px;
            width: 90%;
            border-radius: 4px;
        }

        .btn-add {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-add:hover { background-color: #2ea043; }

        .status-msg {
            margin-top: 15px;
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
        }

        .error { color: var(--error-color); background: rgba(248, 81, 73, 0.1); }
        .success { color: var(--success-color); background: rgba(63, 185, 80, 0.1); }

        .total-row {
            font-weight: bold;
            background: #21262d;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>üìì Registro de Asiento Contable</h2>
    <p>Escribe "caja" o "banco" primero, luego "venta/debito fiscal" o "compra/credito fiscal".</p>

    <table id="tablaContable">
        <thead>
            <tr>
                <th>Cuenta</th>
                <th style="width: 80px;">REF</th>
                <th>D√©bito (Bs)</th>
                <th>Cr√©dito (Bs)</th>
            </tr>
        </thead>
        <tbody id="cuerpoTabla">
            </tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="2" style="text-align: right;">TOTALES:</td>
                <td id="totalDebito">0.00</td>
                <td id="totalCredito">0.00</td>
            </tr>
        </tfoot>
    </table>

    <button class="btn-add" onclick="agregarFila()">+ A√±adir Cuenta</button>
    <div id="mensajeValidacion" class="status-msg error">‚ö†Ô∏è No cuadra (D√©bito ‚â† Cr√©dito)</div>
</div>

<script>
    // Memoria persistente para Referencias (como obtenerRefInteligente)
    const mapaReferencias = {};
    let proximaRef = 1;

    // 1. Agregar nueva fila a la tabla
    function agregarFila() {
        const tbody = document.getElementById('cuerpoTabla');
        const fila = document.createElement('tr');
        
        fila.innerHTML = `
            <td><input type="text" class="nombre-cuenta" oninput="procesarInteligencia(this)" placeholder="Ej: caja"></td>
            <td><input type="number" class="ref-cuenta" readonly></td>
            <td><input type="number" class="monto-debito" oninput="actualizarTotales()" value="0" step="0.01"></td>
            <td><input type="number" class="monto-credito" oninput="actualizarTotales()" value="0" step="0.01"></td>
        `;
        tbody.appendChild(fila);
    }

    // 2. L√≥gica de Inteligencia: IVA y Referencias (Tu onEdit adaptado)
    function procesarInteligencia(input) {
        const filaActual = input.parentElement.parentElement;
        const nombre = input.value.toLowerCase().trim();
        const refInput = filaActual.querySelector('.ref-cuenta');

        // --- REFERENCIAS AUTOM√ÅTICAS ---
        if (nombre !== "") {
            if (!mapaReferencias[nombre]) {
                mapaReferencias[nombre] = proximaRef++;
            }
            refInput.value = mapaReferencias[nombre];
        }

        // --- C√ÅLCULO DE IVA DUAL ---
        const filas = document.querySelectorAll('#cuerpoTabla tr');
        let montoTotalAsiento = 0;
        let esEntrada = false; // Define si es Venta (D√©bito) o Compra (Cr√©dito)

        // Buscamos el monto base en Caja o Banco (como en tu c√≥digo original)
        filas.forEach(f => {
            const n = f.querySelector('.nombre-cuenta').value.toLowerCase();
            if (n.includes("caja") || n.includes("banco")) {
                const deb = parseFloat(f.querySelector('.monto-debito').value) || 0;
                const cre = parseFloat(f.querySelector('.monto-credito').value) || 0;
                
                if (deb > 0) { 
                    montoTotalAsiento = deb; 
                    esEntrada = true; // Flujo de Venta
                } else if (cre > 0) { 
                    montoTotalAsiento = cre; 
                    esEntrada = false; // Flujo de Compra
                }
            }
        });

        if (montoTotalAsiento > 0) {
            const neto = montoTotalAsiento / 1.16;
            const iva = montoTotalAsiento - neto;

            // CASO: VENTAS (Usa D√©bito Fiscal al Cr√©dito)
            if (esEntrada) {
                if (nombre.includes("venta")) {
                    filaActual.querySelector('.monto-credito').value = neto.toFixed(2);
                }
                if (nombre.includes("debito fiscal")) {
                    filaActual.querySelector('.monto-credito').value = iva.toFixed(2);
                }
            } 
            // CASO: COMPRAS (Usa Cr√©dito Fiscal al D√©bito)
            else {
                if (nombre.includes("compra")) {
                    filaActual.querySelector('.monto-debito').value = neto.toFixed(2);
                }
                if (nombre.includes("credito fiscal")) {
                    filaActual.querySelector('.monto-debito').value = iva.toFixed(2);
                }
            }
        }
        actualizarTotales();
    }

    // 3. Validaci√≥n de totales (El mensaje que ten√≠as en rojo/verde)
    function actualizarTotales() {
        let tDebito = 0;
        let tCredito = 0;
        
        document.querySelectorAll('.monto-debito').forEach(i => tDebito += parseFloat(i.value || 0));
        document.querySelectorAll('.monto-credito').forEach(i => tCredito += parseFloat(i.value || 0));

        document.getElementById('totalDebito').innerText = tDebito.toFixed(2);
        document.getElementById('totalCredito').innerText = tCredito.toFixed(2);

        const msg = document.getElementById('mensajeValidacion');
        if (tDebito.toFixed(2) === tCredito.toFixed(2) && tDebito > 0) {
            msg.innerText = "‚úÖ El asiento est√° cuadrado.";
            msg.className = "status-msg success";
        } else {
            msg.innerText = "‚ö†Ô∏è No cuadra (D√©bito ‚â† Cr√©dito)";
            msg.className = "status-msg error";
        }
    }

    // Inicializar con 4 filas
    for(let i=0; i<4; i++) agregarFila();
</script>

</body>
</html>
