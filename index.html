<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Libro Diario Inteligente</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #333; color: white; padding: 10px; }
        td { border: 1px solid #ddd; padding: 10px; }
        [contenteditable="true"] { background-color: #fffdf0; outline: none; }
        [contenteditable="true"]:focus { border: 2px solid #3498db; }
        .controles { margin-top: 20px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-add { background: #3498db; color: white; margin-right: 10px; }
        .btn-save { background: #2ecc71; color: white; }
        .btn-save:disabled { background: #bdc3c7; cursor: not-allowed; }
        #mensajeValidacion { margin: 10px 0; font-weight: bold; }
    </style>
</head>
<body>

    <h2>Asiento Contable con IVA Automático</h2>

    <table id="tabla-asientos">
        <thead>
            <tr>
                <th>Cuenta</th>
                <th>REF</th>
                <th>Débito</th>
                <th>Crédito</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody id="cuerpo-tabla">
            <tr>
                <td contenteditable="true" class="cuenta-nombre">caja</td>
                <td>1</td>
                <td contenteditable="true" class="monto-debito" oninput="gestionarCambio(this)">0</td>
                <td contenteditable="true" class="monto-credito" oninput="gestionarCambio(this)">0</td>
                <td></td>
            </tr>
            <tr>
                <td contenteditable="true" class="cuenta-nombre">venta</td>
                <td>2</td>
                <td contenteditable="true" class="monto-debito" oninput="gestionarCambio(this)">0</td>
                <td contenteditable="true" class="monto-credito" oninput="gestionarCambio(this)">0</td>
                <td></td>
            </tr>
            <tr>
                <td contenteditable="true" class="cuenta-nombre">debito fiscal</td>
                <td>3</td>
                <td contenteditable="true" class="monto-debito" oninput="gestionarCambio(this)">0</td>
                <td contenteditable="true" class="monto-credito" oninput="gestionarCambio(this)">0</td>
                <td></td>
            </tr>
        </tbody>
    </tbody>
    </table>

    <div class="controles">
        <button class="btn-add" onclick="agregarFila()">+ Añadir Fila</button>
        <p>TOTAL DÉBITO: <span id="totalDebito">0.00</span></p>
        <p>TOTAL CRÉDITO: <span id="totalCredito">0.00</span></p>
        <div id="mensajeValidacion">Esperando datos...</div>
        <button id="btnGuardar" class="btn-save" onclick="guardarAsiento()" disabled>Guardar en Supabase</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    
    <script>
        // 1. CONFIGURACIÓN
        const SUPABASE_URL = 'https://hgfutgmypebpnwzqsqqp.supabase.co';
        const SUPABASE_KEY = 'TU_LLAVE_ANON_AQUI'; // <--- PEGA TU LLAVE AQUÍ
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. FUNCIÓN PARA AÑADIR FILAS DINÁMICAMENTE
        function agregarFila() {
            const tabla = document.getElementById('cuerpo-tabla');
            const nuevaFila = document.createElement('tr');
            nuevaFila.innerHTML = `
                <td contenteditable="true" class="cuenta-nombre">nueva cuenta</td>
                <td>-</td>
                <td contenteditable="true" class="monto-debito" oninput="gestionarCambio(this)">0</td>
                <td contenteditable="true" class="monto-credito" oninput="gestionarCambio(this)">0</td>
                <td><button onclick="this.closest('tr').remove(); actualizarTotales();" style="background:#e74c3c; color:white; border-radius:50%;">X</button></td>
            `;
            tabla.appendChild(nuevaFila);
        }

        // 3. LÓGICA DE IVA Y CAMBIOS
        function gestionarCambio(elemento) {
            const fila = elemento.closest('tr');
            const nombreCuenta = fila.querySelector('.cuenta-nombre').innerText.toLowerCase().trim();

            // Si es la cuenta CAJA, calculamos IVA para VENTA y DEBITO FISCAL
            if (nombreCuenta === 'caja') {
                const total = parseFloat(elemento.innerText) || 0;
                const neto = total / 1.16;
                const iva = total - neto;

                const filas = document.querySelectorAll('#cuerpo-tabla tr');
                filas.forEach(f => {
                    const nombre = f.querySelector('.cuenta-nombre').innerText.toLowerCase().trim();
                    if (nombre === 'venta') {
                        f.querySelector('.monto-credito').innerText = neto.toFixed(2);
                    } else if (nombre === 'debito fiscal' || nombre === 'débito fiscal') {
                        f.querySelector('.monto-credito').innerText = iva.toFixed(2);
                    }
                });
            }
            actualizarTotales();
        }

        // 4. VALIDACIÓN DE TOTALES
        function actualizarTotales() {
            let tDebito = 0;
            let tCredito = 0;

            document.querySelectorAll('.monto-debito').forEach(td => tDebito += parseFloat(td.innerText) || 0);
            document.querySelectorAll('.monto-credito').forEach(td => tCredito += parseFloat(td.innerText) || 0);

            document.getElementById('totalDebito').innerText = tDebito.toFixed(2);
            document.getElementById('totalCredito').innerText = tCredito.toFixed(2);

            const btn = document.getElementById('btnGuardar');
            const msg = document.getElementById('mensajeValidacion');

            if (tDebito.toFixed(2) === tCredito.toFixed(2) && tDebito > 0) {
                btn.disabled = false;
                msg.innerText = "✓ Asiento cuadrado.";
                msg.style.color = "green";
            } else {
                btn.disabled = true;
                msg.innerText = "Δ No cuadra.";
                msg.style.color = "red";
            }
        }

        // 5. GUARDAR EN SUPABASE
        async function guardarAsiento() {
            const filas = document.querySelectorAll('#cuerpo-tabla tr');
            const registros = [];

            filas.forEach(fila => {
                const cuenta = fila.querySelector('.cuenta-nombre').innerText.trim();
                const d = parseFloat(fila.querySelector('.monto-debito').innerText) || 0;
                const c = parseFloat(fila.querySelector('.monto-credito').innerText) || 0;

                if (cuenta !== "" && (d > 0 || c > 0)) {
                    registros.push({ cuenta, debito: d, credito: c });
                }
            });

            const { error } = await _supabase.from('asientos').insert(registros);

            if (error) {
                alert("Error: " + error.message);
            } else {
                alert("Asiento guardado correctamente.");
                location.reload();
            }
        }
    </script>
</body>
</html>
