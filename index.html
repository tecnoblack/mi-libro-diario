// Variable global para llevar el control de qué número le toca a cada nombre
let historialCodigos = {};
let ultimoNumeroAsignado = 0;

function inteligenciaFila(elemento) {
    const filaActual = elemento.closest('tr');
    const nombre = filaActual.querySelector('.txt-cuenta').innerText.toLowerCase().trim();
    const celdaRef = filaActual.querySelector('.col-ref');

    if (nombre !== "") {
        // 1. ¿Ya le habíamos asignado un número a esta cuenta en este asiento?
        if (historialCodigos[nombre]) {
            celdaRef.innerText = historialCodigos[nombre];
        } 
        // 2. Si es la primera vez que escribes este nombre, le damos el siguiente número disponible
        else {
            ultimoNumeroAsignado++;
            historialCodigos[nombre] = ultimoNumeroAsignado;
            celdaRef.innerText = ultimoNumeroAsignado;
        }
    } else {
        celdaRef.innerText = "";
    }

    // Mantener la lógica del IVA automática para Caja
    ejecutarCalculoIVA(filaActual, nombre);
    actualizarTotales();
}

function ejecutarCalculoIVA(filaActual, nombre) {
    const montoCaja = parseFloat(filaActual.querySelector('.val-debito').innerText) || 0;
    if (nombre === 'caja' && montoCaja > 0) {
        const neto = montoCaja / 1.16;
        const iva = montoCaja - neto;

        document.querySelectorAll('#cuerpo-tabla tr').forEach(f => {
            const n = f.querySelector('.txt-cuenta').innerText.toLowerCase().trim();
            if (n === 'venta') f.querySelector('.val-credito').innerText = neto.toFixed(2);
            if (n === 'debito fiscal') f.querySelector('.val-credito').innerText = iva.toFixed(2);
        });
    }
}
